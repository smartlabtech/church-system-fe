# Backend Integration Guide

This document explains what changes need to be made to the **backend** repository to serve the frontend in a monolithic deployment.

## Prerequisites

- Built frontend (`dist/` folder) copied to backend's `public/` directory
- Backend is using Express.js (or similar Node.js framework)

## Required Backend Changes

### 1. Directory Structure

Your backend should have this structure:
```
backend/
├── public/              # Frontend static files (from dist/)
│   ├── index.html
│   ├── assets/
│   ├── env-config.js   # Will be overridden by dynamic endpoint
│   ├── manifest.json
│   └── service-worker.js
├── src/
│   ├── routes/
│   │   └── api/        # API routes
│   └── server.js       # Main server file
├── .env
└── package.json
```

### 2. Server Configuration (Express.js Example)

**File: `src/server.js` or `app.js`**

```javascript
const express = require('express');
const path = require('path');
const app = express();

// ============================================
// MIDDLEWARE
// ============================================

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ============================================
// FRONTEND RUNTIME CONFIGURATION
// ============================================
// This MUST come BEFORE static file serving
// It injects environment variables into the frontend at runtime

app.get('/env-config.js', (req, res) => {
  const config = `
// Runtime Environment Configuration
// Generated by backend at ${new Date().toISOString()}
window._env_ = {
  VITE_API_BASE_URL: '${process.env.FRONTEND_API_BASE_URL || '/api/ar'}',
  VITE_API_CHURCH_ID: '${process.env.FRONTEND_CHURCH_ID || '63cd11f4808cc1923ca5f3ca'}'
};
  `;

  res.type('application/javascript');
  res.send(config);
});

// ============================================
// SERVE STATIC FILES (Frontend)
// ============================================
// This serves the built React app from the public directory

app.use(express.static(path.join(__dirname, '../public'), {
  // Optional: Set cache headers for static assets
  maxAge: process.env.NODE_ENV === 'production' ? '1y' : 0,
  setHeaders: (res, path) => {
    // Don't cache index.html or env-config.js
    if (path.endsWith('index.html') || path.endsWith('env-config.js')) {
      res.setHeader('Cache-Control', 'no-cache');
    }
  }
}));

// ============================================
// API ROUTES
// ============================================
// All API routes should be under /api prefix

const apiRouter = require('./routes/api');
app.use('/api', apiRouter);

// Example of specific API routes:
// app.use('/api/ar/users', userRoutes);
// app.use('/api/ar/services', serviceRoutes);
// etc.

// ============================================
// HEALTH CHECK
// ============================================

app.get('/api/health', (req, res) => {
  res.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV
  });
});

// ============================================
// CLIENT-SIDE ROUTING FALLBACK
// ============================================
// This MUST be the LAST route
// All non-API routes serve index.html for client-side routing

app.get('*', (req, res) => {
  // Don't serve index.html for API routes
  if (req.path.startsWith('/api')) {
    return res.status(404).json({ error: 'API endpoint not found' });
  }

  res.sendFile(path.join(__dirname, '../public', 'index.html'));
});

// ============================================
// START SERVER
// ============================================

const PORT = process.env.PORT || 3041;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
  console.log(`Environment: ${process.env.NODE_ENV}`);
  console.log(`Frontend URL: ${process.env.FRONTEND_URL}`);
});

module.exports = app;
```

### 3. Environment Variables

**File: `.env`**

Add these frontend-specific variables:

```bash
# ============================================
# FRONTEND RUNTIME CONFIGURATION
# ============================================

# API Base URL (relative path for same-domain deployment)
FRONTEND_API_BASE_URL=/api/ar

# Church ID
FRONTEND_CHURCH_ID=63cd11f4808cc1923ca5f3ca

# ============================================
# BACKEND CONFIGURATION
# ============================================

NODE_ENV=production
PORT=3041
FRONTEND_URL=https://your-domain.com

# ... rest of your backend env vars
```

### 4. Docker Configuration

**File: `Dockerfile`**

Ensure your Dockerfile copies the frontend build:

```dockerfile
FROM node:18-alpine

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm ci --only=production

# Copy backend source
COPY src/ ./src/

# Copy frontend build (IMPORTANT!)
COPY public/ ./public/

# Expose port
EXPOSE 3041

# Start server
CMD ["node", "src/server.js"]
```

**File: `docker-compose.yml`**

Include frontend environment variables:

```yaml
version: "3.8"

services:
  backend:
    build: .
    container_name: church-system-be
    ports:
      - "3041:3041"
    environment:
      NODE_ENV: production
      PORT: 3041

      # Frontend runtime config
      FRONTEND_API_BASE_URL: "${FRONTEND_API_BASE_URL:-/api/ar}"
      FRONTEND_CHURCH_ID: "${FRONTEND_CHURCH_ID:-63cd11f4808cc1923ca5f3ca}"

      # Backend config
      DB_URI: "${DB_URI}"
      JWT_SECRET: "${JWT_SECRET}"
      # ... other vars
    restart: unless-stopped
```

### 5. Package.json Scripts

**File: `package.json`**

Optional scripts for easier deployment:

```json
{
  "scripts": {
    "start": "node src/server.js",
    "dev": "nodemon src/server.js",
    "deploy:frontend": "cp -r ../church-system-fe/dist/* ./public/",
    "build:docker": "docker build -t church-system-be .",
    "start:docker": "docker-compose up -d"
  }
}
```

## Deployment Workflow

### Development
```bash
# In frontend repo
cd church-system-fe
npm run dev    # Uses Vite dev server with proxy

# In backend repo
cd church-system-be
npm run dev    # Backend API on port 3041
```

### Production
```bash
# 1. Build frontend
cd church-system-fe
npm install --legacy-peer-deps
npm run build

# 2. Copy to backend
cp -r dist/* ../church-system-be/public/

# 3. Deploy backend (which now includes frontend)
cd ../church-system-be
docker-compose up -d
```

## Testing Backend Integration

### 1. Test Runtime Config
```bash
curl http://localhost:3041/env-config.js
```

Expected output:
```javascript
window._env_ = {
  VITE_API_BASE_URL: '/api/ar',
  VITE_API_CHURCH_ID: '63cd11f4808cc1923ca5f3ca'
};
```

### 2. Test Frontend Loading
```bash
curl http://localhost:3041/
```

Should return HTML with `<div id="root"></div>`

### 3. Test API
```bash
curl http://localhost:3041/api/health
```

Should return JSON: `{"status":"ok",...}`

### 4. Test Client-Side Routing
```bash
# These should all return index.html
curl http://localhost:3041/dashboard
curl http://localhost:3041/store
curl http://localhost:3041/admin-panel
```

### 5. Test Browser
Open browser to `http://localhost:3041/` and check:
- [ ] Page loads without errors
- [ ] Console shows no 404 errors
- [ ] Network tab shows `/env-config.js` loads successfully
- [ ] API calls go to `/api/ar/*`
- [ ] Client-side routing works (navigate to /dashboard, /store, etc.)

## Common Mistakes to Avoid

❌ **Static middleware before env-config endpoint**
```javascript
// WRONG ORDER
app.use(express.static('public'));
app.get('/env-config.js', ...);  // This will never run!
```

✅ **Correct order:**
```javascript
// RIGHT ORDER
app.get('/env-config.js', ...);
app.use(express.static('public'));
```

---

❌ **Fallback route before API routes**
```javascript
// WRONG ORDER
app.get('*', (req, res) => res.sendFile('index.html'));
app.use('/api', apiRouter);  // This will never run!
```

✅ **Correct order:**
```javascript
// RIGHT ORDER
app.use('/api', apiRouter);
app.get('*', (req, res) => res.sendFile('index.html'));
```

---

❌ **Serving static env-config.js from public/**
```javascript
// WRONG - This serves the static file from dist/
app.use(express.static('public'));
// Now /env-config.js returns build-time values, not runtime!
```

✅ **Correct - Dynamic endpoint:**
```javascript
// RIGHT - Endpoint generates file dynamically
app.get('/env-config.js', (req, res) => {
  res.send(`window._env_ = {...}`);
});
```

## Security Considerations

⚠️ **Do not expose sensitive backend env vars in frontend config**

```javascript
// BAD - Exposing secrets
window._env_ = {
  DATABASE_URL: process.env.DB_URI,  // ❌ Never!
  JWT_SECRET: process.env.JWT_SECRET  // ❌ Never!
};

// GOOD - Only frontend-safe values
window._env_ = {
  VITE_API_BASE_URL: process.env.FRONTEND_API_BASE_URL,  // ✅ Safe
  VITE_API_CHURCH_ID: process.env.FRONTEND_CHURCH_ID     // ✅ Safe (public ID)
};
```

## Next Steps

1. ✅ Copy built frontend to backend's `public/` directory
2. ✅ Add runtime config endpoint to backend
3. ✅ Configure static file serving
4. ✅ Add client-side routing fallback
5. ✅ Update environment variables
6. ✅ Test all endpoints
7. ✅ Deploy with Docker Compose

For more information, see:
- `DEPLOYMENT.md` - Full deployment guide
- `QUICK_DEPLOYMENT.md` - Quick reference
- `.env.docker` - Environment variable template
